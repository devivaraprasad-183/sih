<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Crop Advisor</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .language-selector {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .language-selector select {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: white;
            font-size: 1rem;
        }

        .form-card {
            background: rgba(255,255,255,0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .voice-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .voice-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .voice-btn:hover {
            background: #ff3742;
            transform: scale(1.05);
        }

        .voice-btn.listening {
            background: #2ed573;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .submit-btn {
            width: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76,175,80,0.3);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .recommendations {
            margin-top: 20px;
        }

        .crop-card {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #4CAF50;
        }

        .crop-card h3 {
            color: #4CAF50;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .crop-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .detail-item {
            background: rgba(76,175,80,0.1);
            padding: 8px 12px;
            border-radius: 6px;
            text-align: center;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #666;
            display: block;
        }

        .detail-value {
            font-weight: 600;
            color: #333;
            font-size: 1rem;
        }

        .sustainability-score {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }

        .score-bar {
            width: 100px;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-left: 10px;
            overflow: hidden;
        }

        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ffa502, #2ed573);
            transition: width 0.3s;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: white;
        }

        .loading.show {
            display: block;
        }

        .offline-indicator {
            background: #ff4757;
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .offline-indicator.show {
            display: block;
        }

        .speak-btn {
            background: #5352ed;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .speak-btn:hover {
            background: #3742fa;
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            
            .crop-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="app-title">üåæ AI Crop Advisor</h1>
            <p id="app-subtitle">Smart farming recommendations for better yields</p>
        </div>

        <div class="offline-indicator" id="offline-indicator">
            üì∂ You're offline. Recommendations will sync when connected.
        </div>

        <div class="language-selector">
            <select id="language-select">
                <option value="en">English</option>
                <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä (Hindi)</option>
                <option value="ta">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)</option>
                <option value="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å (Telugu)</option>
                <option value="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bengali)</option>
            </select>
        </div>

        <div class="form-card">
            <form id="crop-form">
                <div class="form-group">
                    <label for="location" id="location-label">üìç Location (City, State)</label>
                    <input type="text" id="location" name="location" placeholder="e.g., Mumbai, Maharashtra" required>
                </div>

                <div class="form-group">
                    <label for="soil-ph" id="soil-ph-label">üß™ Soil pH Level</label>
                    <input type="number" id="soil-ph" name="soil_ph" step="0.1" min="0" max="14" placeholder="6.5" required>
                </div>

                <div class="form-group">
                    <label for="nitrogen" id="nitrogen-label">N - Nitrogen (kg/ha)</label>
                    <input type="number" id="nitrogen" name="nitrogen" step="1" min="0" placeholder="40" required>
                </div>

                <div class="form-group">
                    <label for="phosphorus" id="phosphorus-label">P - Phosphorus (kg/ha)</label>
                    <input type="number" id="phosphorus" name="phosphorus" step="1" min="0" placeholder="60" required>
                </div>

                <div class="form-group">
                    <label for="potassium" id="potassium-label">K - Potassium (kg/ha)</label>
                    <input type="number" id="potassium" name="potassium" step="1" min="0" placeholder="20" required>
                </div>

                <div class="form-group">
                    <label for="last-crop" id="last-crop-label">üå± Last Grown Crop</label>
                    <select id="last-crop" name="last_crop" required>
                        <option value="">Select previous crop</option>
                        <option value="rice">Rice</option>
                        <option value="wheat">Wheat</option>
                        <option value="maize">Maize</option>
                        <option value="sugarcane">Sugarcane</option>
                        <option value="cotton">Cotton</option>
                        <option value="pulses">Pulses</option>
                        <option value="vegetables">Vegetables</option>
                        <option value="none">No previous crop</option>
                    </select>
                </div>

                <div class="form-group">
                    <label id="voice-input-label">üé§ Voice Input (Optional)</label>
                    <div class="voice-input">
                        <button type="button" id="voice-btn" class="voice-btn">
                            üé§ Speak
                        </button>
                        <input type="text" id="voice-text" placeholder="Voice input will appear here..." readonly>
                    </div>
                </div>

                <button type="submit" class="submit-btn" id="submit-btn">
                    Get Crop Recommendations
                </button>
            
            </form>
        </div>

        <div class="loading" id="loading">
            <p>üîç Analyzing your farm conditions...</p>
            <p>Fetching weather and soil data...</p>
        </div>

        <div class="recommendations" id="recommendations">
            <!-- Crop recommendations will be displayed here -->
        </div>
    </div>

    <script>
        // Define translation text for English and Hindi UI
const translations = {
    en: {
        'app-title': 'üåæ AI Crop Advisor',
        'app-subtitle': 'Smart farming recommendations for better yields',
        'location-label': 'üìç Location (City, State)',
        'soil-ph-label': 'üß™ Soil pH Level',
        'nitrogen-label': 'N - Nitrogen (kg/ha)',
        'phosphorus-label': 'P - Phosphorus (kg/ha)',
        'potassium-label': 'K - Potassium (kg/ha)',
        'last-crop-label': 'üå± Last Grown Crop',
        'voice-input-label': 'üé§ Voice Input (Optional)',
        'submit-btn': 'Get Crop Recommendations'
    },
    hi: {
        'app-title': 'üåæ ‡§è‡§Ü‡§à ‡§´‡§∏‡§≤ ‡§∏‡§≤‡§æ‡§π‡§ï‡§æ‡§∞',
        'app-subtitle': '‡§¨‡•á‡§π‡§§‡§∞ ‡§™‡•à‡§¶‡§æ‡§µ‡§æ‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§ï‡•É‡§∑‡§ø ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂‡•á‡§Ç',
        'location-label': 'üìç ‡§∏‡•ç‡§•‡§æ‡§® (‡§∂‡§π‡§∞, ‡§∞‡§æ‡§ú‡•ç‡§Ø)',
        'soil-ph-label': 'üß™ ‡§Æ‡§ø‡§ü‡•ç‡§ü‡•Ä ‡§ï‡§æ ‡§™‡•Ä‡§è‡§ö ‡§∏‡•ç‡§§‡§∞',
        'nitrogen-label': 'N - ‡§®‡§æ‡§á‡§ü‡•ç‡§∞‡•ã‡§ú‡§® (‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ/‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞)',
        'phosphorus-label': 'P - ‡§´‡§æ‡§∏‡•ç‡§´‡•ã‡§∞‡§∏ (‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ/‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞)',
        'potassium-label': 'K - ‡§™‡•ã‡§ü‡•á‡§∂‡§ø‡§Ø‡§Æ (‡§ï‡§ø‡§ó‡•ç‡§∞‡§æ/‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞)',
        'last-crop-label': 'üå± ‡§™‡§ø‡§õ‡§≤‡•Ä ‡§â‡§ó‡§æ‡§à ‡§ó‡§à ‡§´‡§∏‡§≤',
        'voice-input-label': 'üé§ ‡§Ü‡§µ‡§æ‡§ú ‡§á‡§®‡§™‡•Å‡§ü (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)',
        'submit-btn': '‡§´‡§∏‡§≤ ‡§∏‡§ø‡§´‡§æ‡§∞‡§ø‡§∂‡•á‡§Ç ‡§™‡•ç‡§∞‡§æ‡§™‡•ç‡§§ ‡§ï‡§∞‡•á‡§Ç'
    },
    ta: {
        'app-title': 'üåæ ‡Æè.‡Æê ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡ÆÜ‡Æ≤‡Øã‡Æö‡Æï‡Æ∞‡Øç',
        'app-subtitle': '‡ÆÆ‡Øá‡ÆÆ‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æµ‡Æø‡Æ≥‡Øà‡Æö‡Øç‡Æö‡Æ≤‡ØÅ‡Æï‡Øç‡Æï‡Ææ‡Æ© ‡Æ™‡ØÅ‡Æ§‡Øç‡Æ§‡Æø‡Æö‡Ææ‡Æ≤‡Æø ‡Æµ‡Æø‡Æµ‡Æö‡Ææ‡ÆØ ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øç',
        'location-label': 'üìç ‡Æá‡Æü‡ÆÆ‡Øç (‡Æ®‡Æï‡Æ∞‡ÆÆ‡Øç, ‡ÆÆ‡Ææ‡Æ®‡Æø‡Æ≤‡ÆÆ‡Øç)',
        'soil-ph-label': 'üß™ ‡ÆÆ‡Æ£‡Øç ‡Æ™‡Æø.‡Æé‡Æö‡Øç ‡Æ®‡Æø‡Æ≤‡Øà',
        'nitrogen-label': 'N - ‡Æ®‡Øà‡Æü‡Øç‡Æ∞‡Æú‡Æ©‡Øç (‡Æï‡Æø‡Æ≤‡Øã/‡Æπ‡ØÜ‡Æï‡Øç‡Æü‡Øá‡Æ∞‡Øç)',
        'phosphorus-label': 'P - ‡Æ™‡Ææ‡Æ∏‡Øç‡Æ™‡Æ∞‡Æ∏‡Øç (‡Æï‡Æø‡Æ≤‡Øã/‡Æπ‡ØÜ‡Æï‡Øç‡Æü‡Øá‡Æ∞‡Øç)',
        'potassium-label': 'K - ‡Æ™‡Øä‡Æü‡Øç‡Æü‡Ææ‡Æö‡Æø‡ÆØ‡ÆÆ‡Øç (‡Æï‡Æø‡Æ≤‡Øã/‡Æπ‡ØÜ‡Æï‡Øç‡Æü‡Øá‡Æ∞‡Øç)',
        'last-crop-label': 'üå± ‡Æï‡Æü‡Øà‡Æö‡Æø‡ÆØ‡Ææ‡Æï ‡Æµ‡Æ≥‡Æ∞‡Øç‡Æ§‡Øç‡Æ§ ‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç',
        'voice-input-label': 'üé§ ‡Æï‡ØÅ‡Æ∞‡Æ≤‡Øç ‡Æâ‡Æ≥‡Øç‡Æ≥‡ØÄ‡Æü‡ØÅ (‡Æµ‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡ÆÆ‡Ææ‡Æ©‡Æ§‡ØÅ)',
        'submit-btn': '‡Æ™‡ÆØ‡Æø‡Æ∞‡Øç ‡Æ™‡Æ∞‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ∞‡Øà‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æï'
    },
    bn  :{
        'app-title': 'üåæ ‡¶è‡¶Ü‡¶á ‡¶´‡¶∏‡¶≤ ‡¶â‡¶™‡¶¶‡ßá‡¶∑‡ßç‡¶ü‡¶æ',
        'app-subtitle': '‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶´‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡ßÉ‡¶∑‡¶ø ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶ø‡¶∂',
        'location-label': 'üìç ‡¶Ö‡¶∏‡ßç‡¶•‡¶æ‡¶® (‡¶∂‡¶π‡¶∞, ‡¶∞‡¶æ‡¶ú‡ßç‡¶Ø)',
        'soil-ph-label': 'üß™ ‡¶Æ‡¶æ‡¶ü‡¶ø‡¶∞ ‡¶™‡¶ø‡¶è‡¶á‡¶ö ‡¶∏‡ßç‡¶§‡¶∞',
        'nitrogen-label': 'N - ‡¶®‡¶æ‡¶á‡¶ü‡ßç‡¶∞‡ßã‡¶ú‡ßá‡¶® (‡¶ï‡ßá‡¶ú‡¶ø/‡¶π‡ßá‡¶ï‡ßç‡¶ü‡¶∞)',
        'phosphorus-label': 'P - ‡¶´‡¶∏‡¶´‡¶∞‡¶æ‡¶∏ (‡¶ï‡ßá‡¶ú‡¶ø/‡¶π‡ßá‡¶ï‡ßç‡¶ü‡¶∞)',
        'potassium-label': 'K - ‡¶™‡¶ü‡¶æ‡¶∂‡¶ø‡¶Ø‡¶º‡¶æ‡¶Æ (‡¶ï‡ßá‡¶ú‡¶ø/‡¶π‡ßá‡¶ï‡ßç‡¶ü‡¶∞)',
        'last-crop-label': 'üå± ‡¶∏‡¶∞‡ßç‡¶¨‡¶∂‡ßá‡¶∑ ‡¶ö‡¶æ‡¶∑‡¶ï‡ßÉ‡¶§ ‡¶´‡¶∏‡¶≤',
        'voice-input-label': 'üé§ ‡¶≠‡¶Ø‡¶º‡ßá‡¶∏ ‡¶á‡¶®‡¶™‡ßÅ‡¶ü (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)',
        'submit-btn': '‡¶´‡¶∏‡¶≤‡ßá‡¶∞ ‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞‡¶ø‡¶∂ ‡¶™‡¶æ‡¶®'
    },
    te : {
        'app-title': 'üåæ ‡∞é.‡∞ê ‡∞™‡∞Ç‡∞ü ‡∞∏‡∞≤‡∞π‡∞æ‡∞¶‡∞æ‡∞∞‡±Å',
        'app-subtitle': '‡∞Æ‡∞Ç‡∞ö‡∞ø ‡∞¶‡∞ø‡∞ó‡±Å‡∞¨‡∞°‡∞ø‡∞ï‡∞ø ‡∞∏‡±ç‡∞Æ‡∞æ‡∞∞‡±ç‡∞ü‡±ç ‡∞µ‡±ç‡∞Ø‡∞µ‡∞∏‡∞æ‡∞Ø ‡∞∏‡∞ø‡∞´‡∞æ‡∞∞‡±ç‡∞∏‡±Å‡∞≤‡±Å',
        'location-label': 'üìç ‡∞∏‡±ç‡∞•‡∞æ‡∞®‡∞Ç (‡∞®‡∞ó‡∞∞‡∞Ç, ‡∞∞‡∞æ‡∞∑‡±ç‡∞ü‡±ç‡∞∞‡∞Ç)',
        'soil-ph-label': 'üß™ ‡∞Æ‡∞ü‡±ç‡∞ü‡∞ø ‡∞™‡±Ä‡∞π‡±Ü‡∞ö‡±ç ‡∞∏‡±ç‡∞•‡∞æ‡∞Ø‡∞ø',
        'nitrogen-label': 'N - ‡∞®‡±à‡∞ü‡±ç‡∞∞‡±ã‡∞ú‡∞®‡±ç (‡∞ï‡∞ø‡∞≤‡±ã/‡∞π‡±Ü‡∞ï‡±ç‡∞ü‡±á‡∞∞‡±ç)',
        'phosphorus-label': 'P - ‡∞´‡∞æ‡∞∏‡±ç‡∞´‡∞∞‡∞∏‡±ç (‡∞ï‡∞ø‡∞≤‡±ã/‡∞π‡±Ü‡∞ï‡±ç‡∞ü‡±á‡∞∞‡±ç)',
        'potassium-label': 'K - ‡∞™‡±ä‡∞ü‡∞æ‡∞∑‡∞ø‡∞Ø‡∞Ç (‡∞ï‡∞ø‡∞≤‡±ã/‡∞π‡±Ü‡∞ï‡±ç‡∞ü‡±á‡∞∞‡±ç)',
        'last-crop-label': 'üå± ‡∞ö‡∞ø‡∞µ‡∞∞‡∞ø‡∞ó‡∞æ ‡∞™‡±Ü‡∞Ç‡∞ö‡∞ø‡∞® ‡∞™‡∞Ç‡∞ü',
        'voice-input-label': 'üé§ ‡∞µ‡∞æ‡∞Ø‡∞ø‡∞∏‡±ç ‡∞á‡∞®‡±ç‚Äå‡∞™‡±Å‡∞ü‡±ç (‡∞ê‡∞ö‡±ç‡∞õ‡∞ø‡∞ï‡∞Ç)',
        'submit-btn': '‡∞™‡∞Ç‡∞ü ‡∞∏‡∞ø‡∞´‡∞æ‡∞∞‡±ç‡∞∏‡±Å‡∞≤‡±Å ‡∞™‡±ä‡∞Ç‡∞¶‡∞Ç‡∞°‡∞ø'
    }

};

// Global variables
let isListening = false;        
let recognition;                 
let currentLanguage = 'en';       

// Runs when the DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    setupVoiceRecognition();      
    setupLanguageSelector();      
    setupFormSubmission();        
    setupOfflineDetection();     
    loadCachedRecommendations();  
});

// Setup voice recognition if supported
function setupVoiceRecognition() {
    if ('webkitSpeechRecognition' in window) { 
        recognition = new webkitSpeechRecognition(); 
        recognition.continuous = false;             
        recognition.interimResults = false;         
        recognition.lang = 'en-US';                  

        // When voice recognition starts
        recognition.onstart = function() {
            isListening = true;                      // Set listening flag to true
            const voiceBtn = document.getElementById('voice-btn');
            voiceBtn.classList.add('listening');     // Add class for visual feedback
            voiceBtn.innerHTML = 'üî¥ Listening...';   // Update button text
        };

        // When voice recognition gets a result
        recognition.onresult = function(event) {
            const transcript = event.results[0][0].transcript; // Get spoken text
            document.getElementById('voice-text').value = transcript; // Show it in input
            parseVoiceInput(transcript);                        // Parse it for crop/NPK values
        };

        // When voice recognition ends
        recognition.onend = function() {
            isListening = false;                    // Reset listening flag
            const voiceBtn = document.getElementById('voice-btn');
            voiceBtn.classList.remove('listening'); // Remove visual feedback
            voiceBtn.innerHTML = 'üé§ Speak';         // Reset button text
        };

        // Add click listener to the voice button
        document.getElementById('voice-btn').addEventListener('click', function() {
            if (isListening) {
                recognition.stop();                 // Stop listening if already started
            } else {
                recognition.start();                // Start listening
            }
        });
    } else {
        document.getElementById('voice-btn').style.display = 'none'; // Hide button if unsupported
    }
}

// Parse voice input to auto-fill form
function parseVoiceInput(text) {
    const lowerText = text.toLowerCase(); // Convert to lowercase for easier matching

    // Detect known crop names (English or Hindi)
    if (lowerText.includes('wheat') || lowerText.includes('‡§ó‡•á‡§π‡•Ç‡§Ç')) {
        document.getElementById('last-crop').value = 'wheat';
    }
    if (lowerText.includes('rice') || lowerText.includes('‡§ö‡§æ‡§µ‡§≤')) {
        document.getElementById('last-crop').value = 'rice';
    }

    // Extract numbers from text for NPK values
    const numbers = text.match(/\d+/g); // Get all numbers in input
    if (numbers && numbers.length >= 3) {
        document.getElementById('nitrogen').value = numbers[0];
        document.getElementById('phosphorus').value = numbers[1];
        document.getElementById('potassium').value = numbers[2];
    }
}

// Setup language selector dropdown
function setupLanguageSelector() {
    const languageSelect = document.getElementById('language-select');
    languageSelect.addEventListener('change', function(e) {
        currentLanguage = e.target.value;      // Update current language
        updateLanguage(currentLanguage);       // Update UI and recognition language
    });
}

// Change the UI text based on selected language
function updateLanguage(lang) {
    if (translations[lang]) {
        Object.keys(translations[lang]).forEach(key => {
            const element = document.getElementById(key);
            if (element) {
                if (element.tagName === 'INPUT' || element.tagName === 'BUTTON') {
                    if (key === 'submit-btn') {
                        element.textContent = translations[lang][key]; // Set button text
                    }
                } else {
                    element.textContent = translations[lang][key];     // Set label text
                }
            }
        });
    }

    // Update voice recognition language
    if (recognition) {
        const langCodes = {
            'en': 'en-US',
            'hi': 'hi-IN',
            'ta': 'ta-IN',
            'te': 'te-IN',
            'bn': 'bn-IN'
        };
        recognition.lang = langCodes[lang] || 'en-US';
       // recognition.stop(); // restart recognition to apply new language
    }
}

// Setup the form submission event
function setupFormSubmission() {
    const form = document.getElementById('crop-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();                  // Prevent page reload
        submitRecommendationRequest();      // Call custom submit logic
    });
}

// Handle the recommendation form submission
async function submitRecommendationRequest() {
    const loading = document.getElementById('loading');
    const submitBtn = document.getElementById('submit-btn');

    loading.classList.add('show');          // Show loading indicator
    submitBtn.disabled = true;             // Disable button to prevent resubmission

    // Collect form data 
    const formData = {
        location: document.getElementById('location').value,
        soil_ph: parseFloat(document.getElementById('soil-ph').value),
        nitrogen: parseInt(document.getElementById('nitrogen').value),
        phosphorus: parseInt(document.getElementById('phosphorus').value),
        potassium: parseInt(document.getElementById('potassium').value),
        last_crop: document.getElementById('last-crop').value,
        language: currentLanguage
    };

    try {
        // Check if online
        if (navigator.onLine) {
            // Send POST request to backend
            const response = await fetch('/api/get_recommendation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const recommendations = await response.json(); // Parse JSON result
                displayRecommendations(recommendations);       // Show it in UI
                cacheRecommendations(recommendations);         // Save it in cache
            } else {
                throw new Error('Server error');
            }
        } else {
            // Offline fallback: use mock data
            const mockRecommendations = generateMockRecommendations(formData);
            displayRecommendations(mockRecommendations);
        }
    } catch (error) {
        console.error('Error:', error); // Log errors
        // Fallback to mock data
        const mockRecommendations = generateMockRecommendations(formData);
        displayRecommendations(mockRecommendations);
    } finally {
        loading.classList.remove('show'); // Hide loading indicator
        submitBtn.disabled = false;       // Re-enable submit button
    }
}

// Generate fake data when offline or error
function generateMockRecommendations(formData) {
    const crops = ['Rice', 'Wheat', 'Maize'];
    return {
        recommendations: crops.map((crop, index) => ({
            crop_name: crop,
            predicted_yield: Math.floor(Math.random() * 50) + 20,     // Random yield
            estimated_profit: Math.floor(Math.random() * 30000) + 10000, // Random profit
            sustainability_score: Math.floor(Math.random() * 4) + 7,  // Random score 7-10
            confidence: Math.floor(Math.random() * 20) + 80           // Random confidence 80-99
        }))
    };
}

// Show recommendations on the page
function displayRecommendations(data) {
    const container = document.getElementById('recommendations'); 
    container.innerHTML = ''; // Clear previous results

    data.recommendations.forEach((crop, index) => {
        const cropCard = document.createElement('div');
        cropCard.className = 'crop-card'; // Card style

        // Fill card with crop info
        cropCard.innerHTML = `
            <h3>${crop.crop_name}</h3>
            <div class="crop-details">
                <div class="detail-item">
                    <span class="detail-label">Yield</span>
                    <span class="detail-value">${crop.predicted_yield} kg/acre</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Profit</span>
                    <span class="detail-value">‚Çπ${crop.estimated_profit.toLocaleString()}</span>
                </div>
            </div>
            <div class="sustainability-score">
                <span>Sustainability: </span>
                <div class="score-bar">
                    <div class="score-fill" style="width: ${crop.sustainability_score * 10}%"></div>
                </div>
                <span style="margin-left: 10px;">${crop.sustainability_score}/10</span>
            </div>
            <button class="speak-btn" onclick="speakRecommendation('${crop.crop_name}', ${crop.predicted_yield}, ${crop.estimated_profit})">
                üîä Listen
            </button>
        `;

        container.appendChild(cropCard); // Add card to the page
    });
}

// Text-to-speech to read recommendation aloud
function speakRecommendation(cropName, yield, profit) {
    if ('speechSynthesis' in window) {
        const text = `Recommended crop: ${cropName}. Expected yield: ${yield} kilograms per acre. Estimated profit: ${profit} rupees.`;
        const utterance = new SpeechSynthesisUtterance(text); // Create speech object

        // Set voice language based on UI
        const voices = speechSynthesis.getVoices();
        const langCodes = {
            'en': 'en-US',
            'hi': 'hi-IN',
            'ta': 'ta-IN',
            'te': 'te-IN',
            'bn': 'bn-IN'
        };

        const voice = voices.find(v => v.lang.startsWith(langCodes[currentLanguage]));
        if (voice) {
            utterance.voice = voice; // Set appropriate voice
        }

        speechSynthesis.speak(utterance); // Speak the text
    }
}

// Save recommendations to localStorage
function cacheRecommendations(data) {
    try {
        const cacheData = {
            timestamp: Date.now(), // Save with timestamp
            data: data
        };
        localStorage.setItem('cached_recommendations', JSON.stringify(cacheData));
    } catch (error) {
        console.error('Failed to cache recommendations:', error);
    }
}

// Load from localStorage if data is recent
function loadCachedRecommendations() {
    try {
        const cached = localStorage.getItem('cached_recommendations');
        if (cached) {
            const cacheData = JSON.parse(cached);
            if (Date.now() - cacheData.timestamp < 24 * 60 * 60 * 1000) { // 24 hours
                displayRecommendations(cacheData.data);
            }
        }
    } catch (error) {
        console.error('Failed to load cached recommendations:', error);
    }
}

// Show/hide offline indicator
function setupOfflineDetection() {
    const offlineIndicator = document.getElementById('offline-indicator');

    window.addEventListener('online', function() {
        offlineIndicator.classList.remove('show');
    });

    window.addEventListener('offline', function() {
        offlineIndicator.classList.add('show');
    });

    // On first load
    if (!navigator.onLine) {
        offlineIndicator.classList.add('show');
    }
}

// Register service worker for offline capabilities
if ('serviceWorker' in navigator) {
    window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
        .then(function(registration) {
            console.log('ServiceWorker registration successful');
        })
        .catch(function(err) {
            console.log('ServiceWorker registration failed: ', err);
        });
    });
}

    </script>
</body>
</html>
